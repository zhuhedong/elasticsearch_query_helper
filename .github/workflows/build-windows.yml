name: Build Windows Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.0'
        channel: 'stable'
    
    - name: Verify Flutter installation
      run: |
        flutter --version
        flutter doctor -v
    
    - name: Enable Windows Desktop
      run: flutter config --enable-windows-desktop
    
    - name: Create Windows Platform
      run: flutter create --platforms=windows .
      
    - name: Verify Windows platform creation
      run: |
        if (Test-Path "windows") {
          Write-Host "‚úÖ Windows platform created successfully"
          Get-ChildItem windows -Recurse -Name | Select-Object -First 10
        } else {
          Write-Host "‚ùå Windows platform creation failed"
          exit 1
        }
      shell: powershell
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Clean build
      run: flutter clean
    
    - name: Build Windows Release
      run: flutter build windows --release --verbose
    
    - name: Verify build output
      run: |
        if (Test-Path "build\windows\runner\Release\elasticsearch_query_helper.exe") {
          Write-Host "‚úÖ Build successful"
          Get-ChildItem "build\windows\runner\Release" -Name
        } else {
          Write-Host "‚ùå Build failed - executable not found"
          Get-ChildItem "build\windows\runner" -Recurse -Name | Select-Object -First 20
          exit 1
        }
      shell: powershell
    
    - name: Create Release Package
      run: |
        # Create distribution directory
        New-Item -ItemType Directory -Force -Path "dist"
        New-Item -ItemType Directory -Force -Path "dist\elasticsearch-query-helper-windows"
        
        # Copy build files
        Copy-Item -Path "build\windows\runner\Release\*" -Destination "dist\elasticsearch-query-helper-windows\" -Recurse -Force
        
        # Create README file content
        $readmeContent = "Elasticsearch Query Helper - Windows Version`n`n"
        $readmeContent += "Installation:`n"
        $readmeContent += "1. Extract all files to a folder`n"
        $readmeContent += "2. Double-click elasticsearch_query_helper.exe to run`n`n"
        $readmeContent += "System Requirements:`n"
        $readmeContent += "- Windows 10 or later`n"
        $readmeContent += "- No additional dependencies required`n`n"
        $readmeContent += "Features:`n"
        $readmeContent += "- Dark theme interface`n"
        $readmeContent += "- Support for Elasticsearch v6, v7, v8`n"
        $readmeContent += "- Connection management`n"
        $readmeContent += "- Quick search functionality`n"
        $readmeContent += "- Index browsing`n`n"
        $readmeContent += "Version: 1.0.0`n"
        $readmeContent += "Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')`n"
        
        $readmeContent | Out-File -FilePath "dist\elasticsearch-query-helper-windows\README.txt" -Encoding UTF8
        
        # Create start script content
        $startContent = "@echo off`n"
        $startContent += "echo Starting Elasticsearch Query Helper...`n"
        $startContent += "elasticsearch_query_helper.exe`n"
        $startContent += "if %errorlevel% neq 0 (`n"
        $startContent += "    echo.`n"
        $startContent += "    echo Application exited with error code %errorlevel%`n"
        $startContent += "    pause`n"
        $startContent += ")`n"
        
        $startContent | Out-File -FilePath "dist\elasticsearch-query-helper-windows\start.bat" -Encoding ASCII
        
        Write-Host "‚úÖ Release package created"
        Get-ChildItem "dist\elasticsearch-query-helper-windows" -Name
      shell: powershell
        
    - name: Upload Windows Executable
      uses: actions/upload-artifact@v4
      with:
        name: elasticsearch-query-helper-windows
        path: dist/elasticsearch-query-helper-windows/
        retention-days: 30
        
    - name: Create ZIP Package
      run: |
        $version = "1.0.0"
        $zipName = "elasticsearch-query-helper-windows-v$version.zip"
        Compress-Archive -Path "dist\elasticsearch-query-helper-windows\*" -DestinationPath $zipName -Force
        
        Write-Host "‚úÖ ZIP package created: $zipName"
        $zipInfo = Get-Item $zipName
        Write-Host "üì¶ Size: $([math]::Round($zipInfo.Length / 1MB, 2)) MB"
      shell: powershell
        
    - name: Upload ZIP Package
      uses: actions/upload-artifact@v4
      with:
        name: elasticsearch-query-helper-windows-zip
        path: elasticsearch-query-helper-windows-v*.zip
        retention-days: 30

    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: elasticsearch-query-helper-windows-v*.zip
        body: |
          ## üöÄ Elasticsearch Query Helper - Windows Release
          
          ### üì¶ Installation
          1. Download the ZIP file below
          2. Extract to any folder on your computer
          3. Double-click `elasticsearch_query_helper.exe` or `start.bat`
          
          ### üîß System Requirements
          - Windows 10 or later (64-bit)
          - No additional dependencies required
          - Approximately 100MB disk space
          
          ### ‚ú® Features
          - üé® Dark theme interface
          - üîå Support for Elasticsearch v6, v7, v8
          - üíæ Connection management with saved configurations
          - üîç Quick search functionality
          - üìã Index browsing and management
          - üõ†Ô∏è Advanced query building tools
          
          ### üêõ Troubleshooting
          - If the app doesn't start, try running as administrator
          - For connection issues, check your Elasticsearch server settings
          - Windows Defender may flag the app initially - this is normal for unsigned executables
          
          ### üìù Release Notes
          - Initial Windows release
          - Full feature parity with other platforms
          - Optimized for Windows 10/11
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      if: always()
      run: |
        Write-Host "üéØ Build Summary"
        Write-Host "==============="
        
        if (Test-Path "dist\elasticsearch-query-helper-windows\elasticsearch_query_helper.exe") {
          Write-Host "‚úÖ Windows executable: Created successfully"
          $exeInfo = Get-Item "dist\elasticsearch-query-helper-windows\elasticsearch_query_helper.exe"
          Write-Host "üì¶ Executable size: $([math]::Round($exeInfo.Length / 1MB, 2)) MB"
        } else {
          Write-Host "‚ùå Windows executable: Failed to create"
        }
        
        if (Test-Path "elasticsearch-query-helper-windows-v*.zip") {
          Write-Host "‚úÖ ZIP package: Created successfully"
          $zipFiles = Get-Item "elasticsearch-query-helper-windows-v*.zip"
          foreach ($zip in $zipFiles) {
            Write-Host "üì¶ ZIP size: $([math]::Round($zip.Length / 1MB, 2)) MB"
          }
        } else {
          Write-Host "‚ùå ZIP package: Failed to create"
        }
        
        Write-Host ""
        Write-Host "üéâ Build completed!"
      shell: powershell