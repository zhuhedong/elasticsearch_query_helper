name: Windows Build (No Git)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.0'
        channel: 'stable'
    
    - name: Enable Windows Desktop
      run: |
        Write-Host "Enabling Windows desktop support..."
        flutter config --enable-windows-desktop
        Write-Host "Windows desktop support enabled"
      shell: powershell
    
    - name: Get dependencies
      run: |
        Write-Host "Getting Flutter dependencies..."
        flutter pub get
        Write-Host "Dependencies installed successfully"
      shell: powershell
    
    - name: Clean build
      run: |
        Write-Host "Cleaning previous build..."
        flutter clean
        Write-Host "Clean completed"
      shell: powershell
    
    - name: Build Windows Release
      run: |
        Write-Host "Starting Windows build..."
        flutter build windows --release --verbose
        
        $exePath = "build\windows\runner\Release\elasticsearch_query_helper.exe"
        if (Test-Path $exePath) {
          Write-Host "Build successful!"
          $exe = Get-Item $exePath
          Write-Host "Executable size: $([math]::Round($exe.Length / 1MB, 2)) MB"
          Write-Host "Executable path: $exePath"
        } else {
          Write-Host "Build failed - executable not found at: $exePath"
          Write-Host "Checking build directory structure..."
          if (Test-Path "build") {
            Get-ChildItem "build" -Recurse | Where-Object { $_.Name -like "*.exe" } | ForEach-Object {
              Write-Host "Found exe: $($_.FullName)"
            }
          }
          throw "Build failed - executable not generated"
        }
      shell: powershell
    
    - name: Create Release Package
      run: |
        Write-Host "Creating release package..."
        
        $packageDir = "elasticsearch-query-helper-windows"
        $releaseDir = "build\windows\runner\Release"
        
        if (Test-Path $packageDir) {
          Remove-Item $packageDir -Recurse -Force
        }
        New-Item -ItemType Directory -Force -Path $packageDir
        
        Write-Host "Copying release files..."
        Copy-Item "$releaseDir\*" $packageDir -Recurse -Force
        
        $readmeContent = @"
Elasticsearch Query Helper - Windowsç‰ˆæœ¬

å®‰è£…è¯´æ˜:
1. è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹
2. åŒå‡» elasticsearch_query_helper.exe å¯åŠ¨ç¨‹åº

ç³»ç»Ÿè¦æ±‚:
- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
- æ— éœ€é¢å¤–ä¾èµ–

ç‰ˆæœ¬ä¿¡æ¯:
- ç‰ˆæœ¬: 1.0.0
- æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
- å¹³å°: Windows x64

ä½¿ç”¨è¯´æ˜:
1. å¯åŠ¨ç¨‹åºåï¼Œé¦–å…ˆé…ç½®Elasticsearchè¿æ¥
2. è¾“å…¥æœåŠ¡å™¨åœ°å€ã€ç«¯å£ã€ç”¨æˆ·åå’Œå¯†ç 
3. æµ‹è¯•è¿æ¥æˆåŠŸåå³å¯å¼€å§‹æŸ¥è¯¢

æ•…éšœæ’é™¤:
- å¦‚æœç¨‹åºæ— æ³•å¯åŠ¨ï¼Œè¯·ç¡®ä¿Windowsç‰ˆæœ¬å…¼å®¹
- å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’ŒElasticsearchæœåŠ¡çŠ¶æ€
- å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
"@
        
        $readmeContent | Out-File "$packageDir\README.txt" -Encoding UTF8
        
        $startBatContent = @"
@echo off
echo æ­£åœ¨å¯åŠ¨ Elasticsearch Query Helper...
echo.
elasticsearch_query_helper.exe
echo.
echo ç¨‹åºå·²é€€å‡ºï¼ŒæŒ‰ä»»æ„é”®å…³é—­æ­¤çª—å£...
pause >nul
"@
        
        $startBatContent | Out-File "$packageDir\å¯åŠ¨ç¨‹åº.bat" -Encoding Default
        
        Write-Host "Package created successfully"
        Write-Host "Package contents:"
        Get-ChildItem $packageDir | ForEach-Object {
          if ($_.PSIsContainer) {
            Write-Host "  ğŸ“ $($_.Name)/"
          } else {
            $size = [math]::Round($_.Length / 1KB, 1)
            Write-Host "  ğŸ“„ $($_.Name) ($size KB)"
          }
        }
      shell: powershell
    
    - name: Create ZIP Archive
      run: |
        $zipName = "elasticsearch-query-helper-windows-v1.0.0.zip"
        
        Write-Host "Creating ZIP archive: $zipName"
        Compress-Archive -Path "elasticsearch-query-helper-windows\*" -DestinationPath $zipName -Force
        
        if (Test-Path $zipName) {
          $zipInfo = Get-Item $zipName
          Write-Host "ZIP created successfully"
          Write-Host "ZIP size: $([math]::Round($zipInfo.Length / 1MB, 2)) MB"
          Write-Host "ZIP path: $($zipInfo.FullName)"
        } else {
          throw "Failed to create ZIP archive"
        }
      shell: powershell
    
    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: elasticsearch-query-helper-windows
        path: elasticsearch-query-helper-windows/
        retention-days: 30
    
    - name: Upload ZIP Package
      uses: actions/upload-artifact@v4
      with:
        name: elasticsearch-query-helper-windows-zip
        path: elasticsearch-query-helper-windows-v*.zip
        retention-days: 30
    
    - name: Build Summary
      run: |
        Write-Host "=== æ„å»ºå®Œæˆæ€»ç»“ ==="
        Write-Host "âœ… Flutteråº”ç”¨æ„å»ºæˆåŠŸ"
        Write-Host "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆ"
        Write-Host "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        Write-Host "âœ… ZIPå‹ç¼©åŒ…ç”Ÿæˆ"
        Write-Host ""
        Write-Host "ä¸‹è½½è¯´æ˜:"
        Write-Host "1. è¿›å…¥GitHub Actionsé¡µé¢"
        Write-Host "2. é€‰æ‹©æœ¬æ¬¡æ„å»º"
        Write-Host "3. åœ¨Artifactséƒ¨åˆ†ä¸‹è½½ZIPæ–‡ä»¶"
        Write-Host "4. è§£å‹åè¿è¡Œ elasticsearch_query_helper.exe"
        Write-Host ""
        Write-Host "åŒ…å«æ–‡ä»¶:"
        Write-Host "- elasticsearch_query_helper.exe (ä¸»ç¨‹åº)"
        Write-Host "- README.txt (è¯´æ˜æ–‡æ¡£)"
        Write-Host "- å¯åŠ¨ç¨‹åº.bat (ä¾¿æ·å¯åŠ¨)"
        Write-Host "- å…¶ä»–è¿è¡Œæ—¶æ–‡ä»¶"
      shell: powershell