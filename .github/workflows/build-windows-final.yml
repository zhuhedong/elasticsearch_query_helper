name: Windows Build (Pure)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Download Source Code
      run: |
        Write-Host "å‡†å¤‡æ„å»ºç¯å¢ƒ..."
        Write-Host "å·¥ä½œç›®å½•: $(Get-Location)"
        Write-Host "å¯ç”¨ç£ç›˜ç©ºé—´: $((Get-WmiObject -Class Win32_LogicalDisk -Filter "DeviceID='C:'").FreeSpace / 1GB) GB"
      shell: powershell
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.13.0'
        channel: 'stable'
    
    - name: Create Flutter Project
      run: |
        Write-Host "åˆ›å»ºFlutteré¡¹ç›®ç»“æ„..."
        flutter create --platforms=windows elasticsearch_query_helper
        Set-Location elasticsearch_query_helper
        Write-Host "é¡¹ç›®åˆ›å»ºå®Œæˆï¼Œå½“å‰ç›®å½•: $(Get-Location)"
      shell: powershell
    
    - name: Setup Project Files
      run: |
        Write-Host "è®¾ç½®é¡¹ç›®æ–‡ä»¶..."
        
        # åˆ›å»ºåŸºæœ¬çš„main.dart
        $mainDart = @(
          "import 'package:flutter/material.dart';",
          "",
          "void main() {",
          "  runApp(MyApp());",
          "}",
          "",
          "class MyApp extends StatelessWidget {",
          "  @override",
          "  Widget build(BuildContext context) {",
          "    return MaterialApp(",
          "      title: 'Elasticsearch Query Helper',",
          "      theme: ThemeData.dark(),",
          "      home: MyHomePage(),",
          "    );",
          "  }",
          "}",
          "",
          "class MyHomePage extends StatefulWidget {",
          "  @override",
          "  _MyHomePageState createState() => _MyHomePageState();",
          "}",
          "",
          "class _MyHomePageState extends State<MyHomePage> {",
          "  @override",
          "  Widget build(BuildContext context) {",
          "    return Scaffold(",
          "      appBar: AppBar(",
          "        title: Text('Elasticsearch Query Helper'),",
          "      ),",
          "      body: Center(",
          "        child: Column(",
          "          mainAxisAlignment: MainAxisAlignment.center,",
          "          children: [",
          "            Text(",
          "              'ElasticsearchæŸ¥è¯¢åŠ©æ‰‹',",
          "              style: TextStyle(fontSize: 24, color: Colors.white),",
          "            ),",
          "            SizedBox(height: 20),",
          "            ElevatedButton(",
          "              onPressed: () {",
          "                // TODO: å®ç°è¿æ¥åŠŸèƒ½",
          "              },",
          "              child: Text('è¿æ¥Elasticsearch'),",
          "            ),",
          "          ],",
          "        ),",
          "      ),",
          "    );",
          "  }",
          "}"
        )
        
        $mainContent = $mainDart -join "`n"
        $mainContent | Out-File "lib\main.dart" -Encoding UTF8
        
        Write-Host "é¡¹ç›®æ–‡ä»¶è®¾ç½®å®Œæˆ"
      shell: powershell
    
    - name: Enable Windows Desktop
      run: |
        Write-Host "å¯ç”¨Windowsæ¡Œé¢æ”¯æŒ..."
        flutter config --enable-windows-desktop
        Write-Host "Windowsæ¡Œé¢æ”¯æŒå·²å¯ç”¨"
      shell: powershell
    
    - name: Get Dependencies
      run: |
        Write-Host "è·å–Flutterä¾èµ–..."
        flutter pub get
        Write-Host "ä¾èµ–å®‰è£…å®Œæˆ"
      shell: powershell
    
    - name: Clean Build
      run: |
        Write-Host "æ¸…ç†æ„å»ºç¼“å­˜..."
        flutter clean
        Write-Host "æ¸…ç†å®Œæˆ"
      shell: powershell
    
    - name: Build Windows Release
      run: |
        Write-Host "å¼€å§‹æ„å»ºWindowsç‰ˆæœ¬..."
        flutter build windows --release --verbose
        
        $exePath = "build\windows\runner\Release\elasticsearch_query_helper.exe"
        if (Test-Path $exePath) {
          Write-Host "æ„å»ºæˆåŠŸ!"
          $exe = Get-Item $exePath
          Write-Host "å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $([math]::Round($exe.Length / 1MB, 2)) MB"
          Write-Host "å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„: $exePath"
        } else {
          Write-Host "æ„å»ºå¤±è´¥ - å¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆ: $exePath"
          Write-Host "æ£€æŸ¥æ„å»ºç›®å½•ç»“æ„..."
          if (Test-Path "build") {
            Get-ChildItem "build" -Recurse | Where-Object { $_.Name -like "*.exe" } | ForEach-Object {
              Write-Host "å‘ç°exeæ–‡ä»¶: $($_.FullName)"
            }
          }
          throw "æ„å»ºå¤±è´¥ - å¯æ‰§è¡Œæ–‡ä»¶æœªç”Ÿæˆ"
        }
      shell: powershell
    
    - name: Create Release Package
      run: |
        Write-Host "åˆ›å»ºå‘å¸ƒåŒ…..."
        
        $packageDir = "elasticsearch-query-helper-windows"
        $releaseDir = "build\windows\runner\Release"
        
        if (Test-Path $packageDir) {
          Remove-Item $packageDir -Recurse -Force
        }
        New-Item -ItemType Directory -Force -Path $packageDir
        
        Write-Host "å¤åˆ¶å‘å¸ƒæ–‡ä»¶..."
        Copy-Item "$releaseDir\*" $packageDir -Recurse -Force
        
        # åˆ›å»ºREADMEæ–‡ä»¶
        $readmeLines = @(
          "Elasticsearch Query Helper - Windowsç‰ˆæœ¬",
          "",
          "è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ¼”ç¤ºç‰ˆæœ¬ï¼ŒåŒ…å«åŸºæœ¬çš„Flutteråº”ç”¨ç»“æ„ã€‚",
          "",
          "å®‰è£…è¯´æ˜:",
          "1. è§£å‹æ‰€æœ‰æ–‡ä»¶åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹",
          "2. åŒå‡» elasticsearch_query_helper.exe å¯åŠ¨ç¨‹åº",
          "",
          "ç³»ç»Ÿè¦æ±‚:",
          "- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬",
          "- æ— éœ€é¢å¤–ä¾èµ–",
          "",
          "ç‰ˆæœ¬ä¿¡æ¯:",
          "- ç‰ˆæœ¬: 1.0.0 (æ¼”ç¤ºç‰ˆ)",
          "- æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
          "- å¹³å°: Windows x64",
          "",
          "æ³¨æ„:",
          "è¿™æ˜¯é€šè¿‡GitHub Actionsè‡ªåŠ¨æ„å»ºçš„æ¼”ç¤ºç‰ˆæœ¬ã€‚",
          "å¦‚éœ€å®Œæ•´åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨åŒ…å«å®Œæ•´æºä»£ç çš„ç‰ˆæœ¬ã€‚",
          "",
          "ä½¿ç”¨è¯´æ˜:",
          "1. å¯åŠ¨ç¨‹åºåä¼šçœ‹åˆ°åŸºæœ¬ç•Œé¢",
          "2. è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºåº”ç”¨ï¼Œå±•ç¤ºäº†Flutter Windowsåº”ç”¨çš„åŸºæœ¬ç»“æ„",
          "",
          "æ•…éšœæ’é™¤:",
          "- å¦‚æœç¨‹åºæ— æ³•å¯åŠ¨ï¼Œè¯·ç¡®ä¿Windowsç‰ˆæœ¬å…¼å®¹",
          "- å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥é˜²ç«å¢™è®¾ç½®"
        )
        
        $readmeContent = $readmeLines -join "`n"
        $readmeContent | Out-File "$packageDir\README.txt" -Encoding UTF8
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        $batLines = @(
          "@echo off",
          "echo æ­£åœ¨å¯åŠ¨ Elasticsearch Query Helper (æ¼”ç¤ºç‰ˆ)...",
          "echo.",
          "elasticsearch_query_helper.exe",
          "echo.",
          "echo ç¨‹åºå·²é€€å‡ºï¼ŒæŒ‰ä»»æ„é”®å…³é—­æ­¤çª—å£...",
          "pause >nul"
        )
        
        $startBatContent = $batLines -join "`n"
        $startBatContent | Out-File "$packageDir\å¯åŠ¨ç¨‹åº.bat" -Encoding Default
        
        Write-Host "å‘å¸ƒåŒ…åˆ›å»ºæˆåŠŸ"
        Write-Host "åŒ…å†…å®¹:"
        Get-ChildItem $packageDir | ForEach-Object {
          if ($_.PSIsContainer) {
            Write-Host "  ğŸ“ $($_.Name)/"
          } else {
            $size = [math]::Round($_.Length / 1KB, 1)
            Write-Host "  ğŸ“„ $($_.Name) ($size KB)"
          }
        }
      shell: powershell
    
    - name: Create ZIP Archive
      run: |
        $zipName = "elasticsearch-query-helper-windows-demo-v1.0.0.zip"
        
        Write-Host "åˆ›å»ºZIPå‹ç¼©åŒ…: $zipName"
        Compress-Archive -Path "elasticsearch-query-helper-windows\*" -DestinationPath $zipName -Force
        
        if (Test-Path $zipName) {
          $zipInfo = Get-Item $zipName
          Write-Host "ZIPåˆ›å»ºæˆåŠŸ"
          Write-Host "ZIPå¤§å°: $([math]::Round($zipInfo.Length / 1MB, 2)) MB"
          Write-Host "ZIPè·¯å¾„: $($zipInfo.FullName)"
        } else {
          throw "ZIPå‹ç¼©åŒ…åˆ›å»ºå¤±è´¥"
        }
      shell: powershell
    
    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: elasticsearch-query-helper-windows-demo
        path: elasticsearch-query-helper-windows/
        retention-days: 30
    
    - name: Upload ZIP Package
      uses: actions/upload-artifact@v4
      with:
        name: elasticsearch-query-helper-windows-demo-zip
        path: elasticsearch-query-helper-windows-demo-v*.zip
        retention-days: 30
    
    - name: Build Summary
      run: |
        Write-Host "=== æ„å»ºå®Œæˆæ€»ç»“ ==="
        Write-Host "âœ… Flutteræ¼”ç¤ºåº”ç”¨æ„å»ºæˆåŠŸ"
        Write-Host "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆ"
        Write-Host "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        Write-Host "âœ… ZIPå‹ç¼©åŒ…ç”Ÿæˆ"
        Write-Host ""
        Write-Host "è¯´æ˜:"
        Write-Host "è¿™æ˜¯ä¸€ä¸ªä¸ä¾èµ–ä»»ä½•ä»£ç ä»“åº“çš„æ¼”ç¤ºç‰ˆæœ¬ã€‚"
        Write-Host "åº”ç”¨åŒ…å«åŸºæœ¬çš„Flutterç•Œé¢ç»“æ„ã€‚"
        Write-Host ""
        Write-Host "ä¸‹è½½è¯´æ˜:"
        Write-Host "1. è¿›å…¥Actionsé¡µé¢"
        Write-Host "2. é€‰æ‹©æœ¬æ¬¡æ„å»º"
        Write-Host "3. åœ¨Artifactséƒ¨åˆ†ä¸‹è½½ZIPæ–‡ä»¶"
        Write-Host "4. è§£å‹åè¿è¡Œ elasticsearch_query_helper.exe"
        Write-Host ""
        Write-Host "åŒ…å«æ–‡ä»¶:"
        Write-Host "- elasticsearch_query_helper.exe (æ¼”ç¤ºåº”ç”¨)"
        Write-Host "- README.txt (è¯´æ˜æ–‡æ¡£)"
        Write-Host "- å¯åŠ¨ç¨‹åº.bat (ä¾¿æ·å¯åŠ¨)"
        Write-Host "- å…¶ä»–è¿è¡Œæ—¶æ–‡ä»¶"
      shell: powershell